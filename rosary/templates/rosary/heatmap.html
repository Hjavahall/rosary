{% extends "rosary/base.html" %}
{% block title %}Prayer Heatmap{% endblock %}
{% block content %}
<h2>Global Prayer Heatmap</h2>
<div id="map" style="height: 500px;"></div>

<!-- Leaflet & Heatmap Plugin -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  fetch("{% url 'heatmap_data' %}")
    .then(response => response.json())
    .then(data => {
      console.log("Heatmap data:", data); // For debugging

      // Convert to [lat, lng, intensity] format
      const heatData = data.map(d => [d.lat, d.lng, d.count]);

      // Safety check: log heatData
      console.log("Processed heatData:", heatData);

      // Draw the heat layer
      L.heatLayer(heatData, {
        radius: 25,
        blur: 15,
        maxZoom: 5,
      }).addTo(map);
    });
</script>

{% endblock %}
